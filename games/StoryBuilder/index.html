<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Builder - BIGmini</title>
    
    <!-- 1. Tailwind CSS (CDN is expected for standalone files) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <!-- 3. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 4. Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 5. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; }
        .story-scroll::-webkit-scrollbar { width: 8px; }
        .story-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .story-scroll::-webkit-scrollbar-thumb { background: rgba(217, 70, 239, 0.5); border-radius: 4px; }
        
        /* Fade In Animation classes */
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

    <div id="root"></div>

    <!-- MAIN REACT APP SCRIPT -->
    <script type="text/babel" data-type="module">
        // Import Firebase modules from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- GLOBAL SETUP ---
        const { useState, useEffect, useRef } = React;
        
        // --- FIREBASE CONFIG ---
        let app, auth, db;
        let initError = null;

        try {
            // User provided configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCyCv-vpv1rUYSgMuVs0t1yMGu594pSKVQ",
                authDomain: "bigminigamesbyskye.firebaseapp.com",
                projectId: "bigminigamesbyskye",
                storageBucket: "bigminigamesbyskye.firebasestorage.app",
                messagingSenderId: "56463067198",
                appId: "1:56463067198:web:ff2345bca309d67fbea96f",
                measurementId: "G-13L8BVHXFD"
            };
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            initError = e.message;
        }

        // Use global app ID for data separation if provided, otherwise default
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons({
                        root: iconRef.current ? iconRef.current.parentNode : document,
                        name: name,
                        attrs: { width: size, height: size, class: className }
                    });
                }
            }, [name, size, className]);
            return <i ref={iconRef} data-lucide={name} className={className}></i>;
        };

        // --- HELPER FUNCTIONS ---
        const generateRoomCode = () => {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        };

        // --- MAIN APP COMPONENT ---
        function App() {
            // If Firebase failed to load, show error immediately
            if (initError) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white p-6">
                        <div className="bg-red-500/10 border border-red-500/50 rounded-2xl p-8 max-w-md text-center">
                            <Icon name="alert-triangle" className="w-12 h-12 text-red-500 mx-auto mb-4" />
                            <h1 className="text-2xl font-bold mb-2">Connection Error</h1>
                            <p className="text-slate-300 mb-4">{initError}</p>
                            <div className="text-xs text-slate-500 bg-slate-950 p-3 rounded font-mono text-left overflow-auto">
                                Ensure your Firebase keys are valid.
                            </div>
                        </div>
                    </div>
                );
            }

            const [user, setUser] = useState(null);
            const [view, setView] = useState('home'); // home, lobby, game, spectator
            const [roomCode, setRoomCode] = useState('');
            const [gameState, setGameState] = useState(null);
            const [error, setError] = useState('');
            const [userName, setUserName] = useState('');

            // Auth Initialization
            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth failed", err);
                        setError("Could not sign in. Check console/network.");
                    }
                };
                initAuth();
                
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    const params = new URLSearchParams(window.location.search);
                    const urlRoom = params.get('room');
                    if (urlRoom) setRoomCode(urlRoom);
                });
                return () => unsubscribe();
            }, []);

            // Game State Sync
            useEffect(() => {
                if (!user || !roomCode || !db) return;
                
                // Using APP_ID for the collection path to keep data organized
                const roomRef = doc(db, 'artifacts', APP_ID, 'public', 'data', `sb_room_${roomCode}`);
                
                const unsubscribe = onSnapshot(roomRef, (snapshot) => {
                    if (snapshot.exists()) {
                        setGameState(snapshot.data());
                        if (view === 'home' && snapshot.data().players.some(p => p.uid === user.uid)) {
                           setView('lobby');
                        }
                    } else {
                        if (view !== 'home' && view !== 'spectator') {
                            setError("Room closed or does not exist.");
                            setView('home');
                        }
                    }
                }, (err) => {
                    console.error("Snapshot error:", err);
                });

                return () => unsubscribe();
            }, [roomCode, user, view]);

            // --- ACTIONS ---

            const createRoom = async () => {
                if (!userName.trim()) return setError("Please enter a name");
                const code = generateRoomCode();
                setRoomCode(code);
                
                const initialState = {
                    code: code,
                    hostId: user.uid,
                    status: 'lobby',
                    genre: 'Adventure',
                    story: ["Once upon a time..."],
                    players: [{ uid: user.uid, name: userName, score: 0 }],
                    candidates: [],
                    votes: [],
                    createdAt: Date.now()
                };

                try {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', `sb_room_${code}`), initialState);
                    setView('lobby');
                } catch (e) {
                    console.error(e);
                    setError("Failed to create room.");
                }
            };

            const joinRoom = async () => {
                if (!userName.trim()) return setError("Please enter a name");
                if (!roomCode || roomCode.length !== 4) return setError("Invalid room code");
                
                const roomRef = doc(db, 'artifacts', APP_ID, 'public', 'data', `sb_room_${roomCode}`);
                try {
                    const snap = await getDoc(roomRef);
                    if (!snap.exists()) return setError("Room not found");
                    
                    const data = snap.data();
                    if (!data.players.some(p => p.uid === user.uid)) {
                        if (data.status !== 'lobby') return setError("Game in progress. Join as spectator?");
                        await updateDoc(roomRef, {
                            players: arrayUnion({ uid: user.uid, name: userName, score: 0 })
                        });
                    }
                    setView('lobby');
                } catch (e) {
                    console.error(e);
                    setError("Failed to join.");
                }
            };

            const enterSpectator = () => {
                if (!roomCode) return setError("Enter a room code to spectate");
                setView('spectator');
            };

            // --- RENDER ---

            if (!user) return <div className="h-screen flex items-center justify-center text-fuchsia-500 animate-pulse">Connecting to server...</div>;

            return (
                <div className="max-w-4xl mx-auto p-4 md:p-6 min-h-screen flex flex-col">
                    {/* Header */}
                    {view !== 'spectator' && (
                        <header className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                            <div className="flex items-center gap-2">
                                <a href="../../index.html" className="text-slate-400 hover:text-white transition-colors">
                                    <Icon name="arrow-left" size={20} />
                                </a>
                                <h1 className="font-bold text-xl tracking-tight text-white">Story Builder</h1>
                            </div>
                            {roomCode && (
                                <div className="bg-slate-800 px-3 py-1 rounded-full text-sm font-mono text-fuchsia-400 border border-slate-700">
                                    {roomCode}
                                </div>
                            )}
                        </header>
                    )}

                    {/* Errors */}
                    {error && (
                        <div className="bg-red-500/20 border border-red-500 text-red-200 p-3 rounded-lg mb-4 text-sm flex justify-between items-center">
                            <span>{error}</span>
                            <button onClick={() => setError('')} className="font-bold text-lg">&times;</button>
                        </div>
                    )}

                    {/* View Router */}
                    {view === 'home' && (
                        <HomeView 
                            userName={userName} 
                            setUserName={setUserName} 
                            roomCode={roomCode} 
                            setRoomCode={setRoomCode}
                            createRoom={createRoom}
                            joinRoom={joinRoom}
                            enterSpectator={enterSpectator}
                        />
                    )}

                    {view === 'lobby' && gameState && (
                        <LobbyView 
                            gameState={gameState} 
                            user={user} 
                            db={db} 
                            appId={APP_ID}
                        />
                    )}

                    {(view === 'lobby' || view === 'game') && gameState && gameState.status !== 'lobby' && (
                        <GameController 
                            gameState={gameState} 
                            user={user} 
                            db={db} 
                            appId={APP_ID}
                        />
                    )}

                    {view === 'spectator' && (
                        <SpectatorView 
                            roomCode={roomCode} 
                            gameState={gameState} 
                        />
                    )}
                </div>
            );
        }

        // --- SUB COMPONENTS ---

        const HomeView = ({ userName, setUserName, roomCode, setRoomCode, createRoom, joinRoom, enterSpectator }) => (
            <div className="flex-1 flex flex-col justify-center items-center max-w-md mx-auto w-full animate-in fade-in slide-in-from-bottom-4 duration-700">
                <div className="w-full bg-slate-800/50 backdrop-blur border border-slate-700 p-8 rounded-2xl shadow-xl">
                    <div className="mb-6">
                        <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Your Name</label>
                        <input 
                            type="text" 
                            value={userName} 
                            onChange={(e) => setUserName(e.target.value)}
                            placeholder="e.g. StoryTeller99"
                            className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-fuchsia-500 transition-colors"
                        />
                    </div>

                    <div className="space-y-3">
                        <button 
                            onClick={createRoom}
                            className="w-full bg-gradient-to-r from-fuchsia-600 to-purple-600 hover:from-fuchsia-500 hover:to-purple-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-purple-500/20 transition-all transform active:scale-95 flex items-center justify-center gap-2"
                        >
                            <Icon name="play" size={18} /> Host New Game
                        </button>
                        
                        <div className="relative flex py-2 items-center">
                            <div className="flex-grow border-t border-slate-700"></div>
                            <span className="flex-shrink mx-4 text-slate-500 text-xs">OR JOIN</span>
                            <div className="flex-grow border-t border-slate-700"></div>
                        </div>

                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                value={roomCode} 
                                onChange={(e) => setRoomCode(e.target.value.toUpperCase())}
                                placeholder="CODE"
                                className="w-24 bg-slate-900 border border-slate-700 rounded-lg p-3 text-center text-white font-mono uppercase tracking-widest focus:outline-none focus:border-fuchsia-500"
                                maxLength={4}
                            />
                            <button 
                                onClick={joinRoom}
                                className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-xl transition-colors"
                            >
                                Join Room
                            </button>
                        </div>
                    </div>

                    <div className="mt-8 pt-6 border-t border-slate-700 text-center">
                        <button 
                            onClick={enterSpectator}
                            className="text-slate-500 hover:text-fuchsia-400 text-sm flex items-center justify-center gap-2 mx-auto transition-colors"
                        >
                            <Icon name="tv" size={16} /> Enter Spectator Mode (TV)
                        </button>
                    </div>
                </div>
            </div>
        );

        const LobbyView = ({ gameState, user, db, appId }) => {
            const isHost = gameState.hostId === user.uid;
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `sb_room_${gameState.code}`);

            const startGame = async () => await updateDoc(roomRef, { status: 'writing' });
            const changeGenre = async (e) => await updateDoc(roomRef, { genre: e.target.value });

            if (gameState.status !== 'lobby') return null;

            // QR Code specific to this room
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.href.split('?')[0] + `?room=${gameState.code}`)}&color=d946ef&bgcolor=0f172a`;

            return (
                <div className="flex flex-col md:flex-row gap-8 animate-in fade-in zoom-in-95">
                    <div className="flex-1 space-y-6">
                        <div className="bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
                            <h2 className="text-2xl font-bold mb-4 flex items-center gap-2"><Icon name="users" /> Lobby</h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs text-slate-400 uppercase font-bold">Genre</label>
                                    {isHost ? (
                                        <select 
                                            value={gameState.genre} 
                                            onChange={changeGenre}
                                            className="block w-full mt-1 bg-slate-900 border border-slate-700 rounded p-2 text-white"
                                        >
                                            <option>Adventure</option>
                                            <option>Horror</option>
                                            <option>Sci-Fi</option>
                                            <option>Romance</option>
                                            <option>Mystery</option>
                                            <option>Comedy</option>
                                        </select>
                                    ) : (
                                        <div className="text-xl font-medium text-fuchsia-400">{gameState.genre}</div>
                                    )}
                                </div>
                                <div className="flex items-center gap-4 bg-slate-900 p-4 rounded-lg border border-slate-800">
                                    <img src={qrUrl} alt="Join QR" className="w-20 h-20 rounded-lg" />
                                    <div>
                                        <div className="text-sm text-slate-400 mb-1">Room Code</div>
                                        <div className="text-4xl font-mono font-bold tracking-widest text-white">{gameState.code}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {isHost ? (
                            <button 
                                onClick={startGame}
                                className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/20 text-lg transition-all"
                            >
                                Start Game
                            </button>
                        ) : (
                            <div className="text-center p-4 text-slate-400 bg-slate-800/30 rounded-xl animate-pulse">
                                Waiting for host to start...
                            </div>
                        )}
                    </div>

                    <div className="flex-1 bg-slate-800/30 p-6 rounded-2xl border border-slate-700">
                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                            Players ({gameState.players.length})
                        </h3>
                        <div className="grid gap-2">
                            {gameState.players.map(p => (
                                <div key={p.uid} className="bg-slate-800 p-3 rounded-lg flex items-center justify-between">
                                    <span className="font-medium">{p.name}</span>
                                    {p.uid === gameState.hostId && <span className="text-xs bg-fuchsia-500/20 text-fuchsia-300 px-2 py-1 rounded">HOST</span>}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const GameController = ({ gameState, user, db, appId }) => {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `sb_room_${gameState.code}`);
            const [submission, setSubmission] = useState('');
            const [hasSubmitted, setHasSubmitted] = useState(false);
            const [selectedVote, setSelectedVote] = useState(null);

            useEffect(() => {
                setSubmission('');
                setHasSubmitted(false);
                setSelectedVote(null);
            }, [gameState.status, gameState.story.length]);

            useEffect(() => {
                if (gameState.status === 'writing') {
                    const alreadySubmitted = gameState.candidates?.some(c => c.uid === user.uid);
                    setHasSubmitted(alreadySubmitted);
                }
                if (gameState.status === 'voting') {
                    const alreadyVoted = gameState.votes?.some(v => v.voter === user.uid);
                    if (alreadyVoted) setSelectedVote('done'); 
                }
            }, [gameState, user.uid]);

            const submitSentence = async () => {
                if (!submission.trim()) return;
                setHasSubmitted(true);
                await updateDoc(roomRef, { candidates: arrayUnion({ uid: user.uid, text: submission, votes: [] }) });
            };

            const castVote = async (candidateUid) => {
                setSelectedVote(candidateUid);
                await updateDoc(roomRef, { votes: arrayUnion({ voter: user.uid, candidate: candidateUid }) });
            };

            // Host Logic for State Transitions
            useEffect(() => {
                if (gameState.hostId !== user.uid) return;

                const checkProgress = async () => {
                    // Check Writing Phase Completion
                    if (gameState.status === 'writing') {
                        if (gameState.candidates && gameState.candidates.length >= gameState.players.length && gameState.players.length > 0) {
                            await updateDoc(roomRef, { status: 'voting', votes: [] });
                        }
                    } 
                    // Check Voting Phase Completion
                    else if (gameState.status === 'voting') {
                        if (gameState.votes && gameState.votes.length >= gameState.players.length && gameState.players.length > 0) {
                            // Tally Votes
                            const counts = {};
                            gameState.votes.forEach(v => { counts[v.candidate] = (counts[v.candidate] || 0) + 1; });
                            
                            let winnerUid = null, maxVotes = -1;
                            Object.keys(counts).forEach(uid => {
                                if (counts[uid] > maxVotes) { maxVotes = counts[uid]; winnerUid = uid; }
                            });

                            if (!winnerUid && gameState.candidates.length > 0) winnerUid = gameState.candidates[0].uid;
                            const winningCandidate = gameState.candidates.find(c => c.uid === winnerUid);

                            if (winningCandidate) {
                                // Decide if game ends (e.g., after 5 rounds)
                                const isFinished = gameState.story.length + 1 >= 6; 
                                await updateDoc(roomRef, {
                                    story: arrayUnion(winningCandidate.text),
                                    status: isFinished ? 'finished' : 'writing',
                                    candidates: [],
                                    votes: []
                                });
                            }
                        }
                    }
                };
                const timer = setTimeout(checkProgress, 2000);
                return () => clearTimeout(timer);
            }, [gameState, user.uid]);

            if (gameState.status === 'finished') {
                return (
                    <div className="max-w-2xl mx-auto space-y-6 animate-in zoom-in-95">
                        <div className="text-center mb-8">
                            <h2 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-400 to-purple-600 mb-2">The End</h2>
                        </div>
                        <div className="bg-white text-slate-900 p-8 rounded-lg shadow-2xl font-serif text-lg leading-relaxed relative">
                            {gameState.story.join(" ")}
                        </div>
                        <button onClick={() => updateDoc(roomRef, { status: 'lobby', story: ["Once upon a time..."], candidates: [] })} className="w-full bg-slate-700 py-3 rounded-lg font-bold">Back to Lobby</button>
                    </div>
                );
            }

            return (
                <div className="max-w-lg mx-auto flex flex-col h-full">
                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700 mb-6 shadow-inner">
                        <div className="text-xs text-slate-500 uppercase font-bold mb-2">Previous Story</div>
                        <p className="text-slate-300 italic">"...{gameState.story.slice(-2).join(" ")}"</p>
                    </div>

                    {gameState.status === 'writing' && (
                        <div className="animate-in slide-in-from-right-4">
                            <h2 className="text-xl font-bold mb-4 text-fuchsia-400">Write the next sentence</h2>
                            {hasSubmitted ? (
                                <div className="text-center p-8 bg-slate-800 rounded-xl border border-slate-700">
                                    <Icon name="clock" className="w-12 h-12 text-fuchsia-500 mx-auto mb-4 animate-pulse" />
                                    <p className="font-bold text-lg">Waiting for others...</p>
                                    <p className="text-sm text-slate-400 mt-2">{gameState.candidates?.length} / {gameState.players.length} submitted</p>
                                </div>
                            ) : (
                                <div>
                                    <textarea 
                                        value={submission}
                                        onChange={(e) => setSubmission(e.target.value)}
                                        className="w-full bg-slate-800 border border-slate-600 rounded-xl p-4 text-white focus:border-fuchsia-500 focus:outline-none h-32 mb-4"
                                        placeholder="And then suddenly..."
                                        maxLength={140}
                                    />
                                    <button 
                                        onClick={submitSentence}
                                        className="w-full bg-fuchsia-600 hover:bg-fuchsia-500 text-white font-bold py-3 rounded-xl transition-all"
                                    >
                                        Submit Sentence
                                    </button>
                                </div>
                            )}
                        </div>
                    )}

                    {gameState.status === 'voting' && (
                        <div className="animate-in slide-in-from-right-4">
                            <h2 className="text-xl font-bold mb-4 text-purple-400">Vote for the best twist</h2>
                            <div className="space-y-3">
                                {gameState.candidates.map((c, i) => {
                                    const isSelected = selectedVote === c.uid;
                                    const alreadyVoted = gameState.votes?.some(v => v.voter === user.uid);
                                    
                                    return (
                                        <button
                                            key={i}
                                            disabled={alreadyVoted}
                                            onClick={() => castVote(c.uid)}
                                            className={`w-full text-left p-4 rounded-xl border transition-all ${
                                                isSelected 
                                                    ? 'bg-purple-600 border-purple-400 text-white shadow-lg' 
                                                    : 'bg-slate-800 border-slate-700 hover:border-slate-500'
                                            } ${alreadyVoted && !isSelected ? 'opacity-50 cursor-not-allowed' : ''}`}
                                        >
                                            "{c.text}"
                                        </button>
                                    );
                                })}
                            </div>
                            <div className="mt-4 text-center text-sm text-slate-500">
                                {gameState.votes?.length || 0} / {gameState.players.length} votes cast
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const SpectatorView = ({ roomCode, gameState }) => {
            if (!gameState) return <div className="flex h-screen items-center justify-center text-slate-500">Connecting to {roomCode}...</div>;

            return (
                <div className="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center p-8 overflow-hidden z-50">
                     {/* Background Animation */}
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-fuchsia-600/20 rounded-full blur-3xl animate-pulse"></div>
                        <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-600/20 rounded-full blur-3xl animate-pulse delay-1000"></div>
                    </div>
                    
                    <div className="relative z-10 w-full max-w-6xl h-full flex flex-col">
                        <div className="flex justify-between items-center mb-8 border-b border-slate-700 pb-6">
                            <div>
                                <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-400 to-purple-400">
                                    {gameState.genre} Story
                                </h1>
                                <div className="text-2xl text-slate-400 mt-2">Join at <span className="text-white font-bold">bigmini.games</span> Code: <span className="text-fuchsia-400 font-mono font-bold px-2">{gameState.code}</span></div>
                            </div>
                            {gameState.status === 'lobby' && (
                                <img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.href.split('?')[0] + `?room=${gameState.code}`)}&color=d946ef&bgcolor=0f172a`} className="rounded-xl border-2 border-slate-700" alt="Join QR" />
                            )}
                        </div>

                        <div className="flex-grow flex items-center justify-center w-full">
                             {gameState.status === 'lobby' && (
                                <div className="text-center w-full">
                                    <h2 className="text-3xl font-bold mb-8 text-slate-300">Waiting for Players...</h2>
                                    <div className="flex flex-wrap gap-4 justify-center">
                                        {gameState.players.map(p => (
                                            <div key={p.uid} className="bg-slate-800 px-8 py-6 rounded-full text-2xl font-bold border-2 border-slate-700 animate-bounce">
                                                {p.name}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {(gameState.status === 'writing' || gameState.status === 'voting' || gameState.status === 'finished') && (
                                <div className="w-full h-full flex flex-col gap-6">
                                    <div className="flex-1 overflow-y-auto bg-slate-800/40 p-12 rounded-3xl border border-slate-700/50 shadow-2xl backdrop-blur-sm story-scroll">
                                        <p className="text-4xl leading-loose font-serif text-slate-200">
                                            {gameState.story.map((s, i) => (
                                                <span key={i} className={i === gameState.story.length - 1 ? "text-white font-bold bg-fuchsia-500/20 px-2 rounded animate-pulse decoration-clone" : "opacity-80"}>
                                                    {s}{" "}
                                                </span>
                                            ))}
                                        </p>
                                    </div>
                                    <div className="h-24 bg-slate-900/80 border-t border-slate-700 flex items-center justify-center rounded-xl">
                                        {gameState.status === 'writing' && <div className="text-3xl font-bold text-fuchsia-400 animate-pulse">Writers are writing...</div>}
                                        {gameState.status === 'voting' && <div className="text-3xl font-bold text-purple-400 animate-pulse">Voting in progress...</div>}
                                        {gameState.status === 'finished' && <div className="text-3xl font-black text-green-400">STORY COMPLETE</div>}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
