<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia Party - BIGmini</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <!-- 3. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 5. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; }
        
        /* Animations */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .glass-panel { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Custom Range Slider */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: #22d3ee;
            cursor: pointer;
            margin-top: -8px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer;
            background: #475569;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen selection:bg-cyan-500 selection:text-white">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion, increment, deleteField } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIGURATION ---
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyCyCv-vpv1rUYSgMuVs0t1yMGu594pSKVQ",
            authDomain: "bigminigamesbyskye.firebaseapp.com",
            projectId: "bigminigamesbyskye",
            storageBucket: "bigminigamesbyskye.firebasestorage.app",
            messagingSenderId: "56463067198",
            appId: "1:56463067198:web:ff2345bca309d67fbea96f",
            measurementId: "G-13L8BVHXFD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UTILS ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons({
                        root: iconRef.current ? iconRef.current.parentNode : document,
                        name: name,
                        attrs: { width: size, height: size, class: className }
                    });
                }
            }, [name, size, className]);
            return <i ref={iconRef} data-lucide={name} className={className}></i>;
        };

        const generateRoomCode = () => {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        };

        const decodeHTML = (html) => {
            const txt = document.createElement('textarea');
            txt.innerHTML = html;
            return txt.value;
        };

        const shuffle = (array) => {
            return array.map(value => ({ value, sort: Math.random() }))
                        .sort((a, b) => a.sort - b.sort)
                        .map(({ value }) => value);
        };

        // --- CONSTANTS ---
        const CATEGORIES = [
            { id: '9', name: 'General Knowledge', icon: 'globe' },
            { id: '11', name: 'Film', icon: 'film' },
            { id: '12', name: 'Music', icon: 'music' },
            { id: '15', name: 'Video Games', icon: 'gamepad-2' },
            { id: '17', name: 'Science', icon: 'flask-conical' },
            { id: '23', name: 'History', icon: 'scroll' },
            { id: '10', name: 'Books', icon: 'book' },
            { id: '21', name: 'Sports', icon: 'trophy' }
        ];

        const DIFFICULTIES = ['easy', 'medium', 'hard'];

        const TEAMS = {
            red: { name: 'Red Team', color: 'bg-red-500', text: 'text-red-500', border: 'border-red-500' },
            blue: { name: 'Blue Team', color: 'bg-blue-500', text: 'text-blue-500', border: 'border-blue-500' },
            green: { name: 'Green Team', color: 'bg-green-500', text: 'text-green-500', border: 'border-green-500' },
            yellow: { name: 'Yellow Team', color: 'bg-yellow-500', text: 'text-yellow-500', border: 'border-yellow-500' }
        };

        // --- COMPONENTS ---

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home'); 
            const [roomCode, setRoomCode] = useState('');
            const [gameState, setGameState] = useState(null);
            const [error, setError] = useState('');
            const [userName, setUserName] = useState('');

            // Auth
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth Error", err);
                        setError("Connection failed.");
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                
                // Check URL params
                const params = new URLSearchParams(window.location.search);
                if (params.get('room')) setRoomCode(params.get('room'));

                return () => unsubscribe();
            }, []);

            // Game Sync
            useEffect(() => {
                if (!user || !roomCode) return;
                
                const roomRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'rooms', `trivia_room_${roomCode}`);
                
                const unsubscribe = onSnapshot(roomRef, (snap) => {
                    if (snap.exists()) {
                        setGameState(snap.data());
                        if (view === 'home' && snap.data().players.some(p => p.uid === user.uid)) {
                            setView('lobby');
                        }
                    } else if (view !== 'home' && view !== 'spectator') {
                        setError("Room closed.");
                        setView('home');
                    }
                }, (err) => console.error(err));

                return () => unsubscribe();
            }, [user, roomCode, view]);

            // --- ACTIONS ---

            const createRoom = async () => {
                if (!userName) return setError("Enter name");
                const code = generateRoomCode();
                setRoomCode(code);
                
                const initialState = {
                    code,
                    hostId: user.uid,
                    status: 'lobby', 
                    players: [{ uid: user.uid, name: userName, score: 0, team: 'red', votes: { category: '9', difficulty: 'medium' } }],
                    currentQuestionIndex: 0,
                    questions: [], 
                    currentAnswers: {}, 
                    liveVotes: {}, 
                    timeLeft: 20, // synced numeric timer
                    
                    // Settings
                    gameMode: 'ffa', // 'ffa' or 'teams'
                    timerDuration: 20, // 10-30
                };

                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'rooms', `trivia_room_${code}`), initialState);
                setView('lobby');
            };

            const joinRoom = async () => {
                if (!userName || roomCode.length !== 4) return setError("Invalid input");
                const roomRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'rooms', `trivia_room_${roomCode}`);
                
                try {
                    const snap = await getDoc(roomRef);
                    if (!snap.exists()) return setError("Room not found");
                    const data = snap.data();
                    
                    if (!data.players.some(p => p.uid === user.uid)) {
                        if (data.status !== 'lobby') return setError("Game in progress");
                        await updateDoc(roomRef, {
                            players: arrayUnion({ uid: user.uid, name: userName, score: 0, team: 'blue', votes: { category: '9', difficulty: 'medium' } })
                        });
                    }
                    setView('lobby');
                } catch (e) { setError("Join failed"); }
            };

            // --- RENDER ---

            if (!user) return <div className="h-screen flex items-center justify-center text-cyan-400">Loading Trivia Party...</div>;

            return (
                <div className="max-w-5xl mx-auto p-4 min-h-screen flex flex-col relative overflow-hidden">
                    {/* Background Blobs */}
                    <div className="absolute -top-20 -left-20 w-96 h-96 bg-cyan-600/20 rounded-full blur-[100px] pointer-events-none"></div>
                    <div className="absolute top-1/2 -right-20 w-80 h-80 bg-fuchsia-600/20 rounded-full blur-[100px] pointer-events-none"></div>

                    {/* Header */}
                    {view !== 'spectator' && (
                        <header className="relative z-10 flex justify-between items-center mb-6 py-4 border-b border-white/10">
                            <div className="flex items-center gap-3">
                                <a href="../../index.html" className="bg-slate-800 p-2 rounded-full hover:bg-slate-700 transition">
                                    <Icon name="arrow-left" size={20} />
                                </a>
                                <div className="font-black text-2xl tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-fuchsia-400">
                                    TRIVIA PARTY
                                </div>
                            </div>
                            {roomCode && <div className="font-mono bg-slate-800 px-3 py-1 rounded text-cyan-400">{roomCode}</div>}
                        </header>
                    )}

                    {error && (
                        <div className="bg-red-500/20 border border-red-500 text-red-200 p-3 rounded-lg mb-4 flex justify-between">
                            {error} <button onClick={() => setError('')}>&times;</button>
                        </div>
                    )}

                    {view === 'home' && (
                        <HomeView {...{ userName, setUserName, roomCode, setRoomCode, createRoom, joinRoom, enterSpectator: () => setView('spectator') }} />
                    )}

                    {view === 'lobby' && gameState && (
                        <LobbyView {...{ gameState, user, db }} />
                    )}

                    {view === 'lobby' && gameState && gameState.status !== 'lobby' && (
                        <GameController {...{ gameState, user, db }} />
                    )}

                    {view === 'spectator' && (
                        <SpectatorView {...{ roomCode, gameState }} />
                    )}
                </div>
            );
        }

        // --- SUB COMPONENTS ---

        const HomeView = ({ userName, setUserName, roomCode, setRoomCode, createRoom, joinRoom, enterSpectator }) => (
            <div className="flex-1 flex flex-col items-center justify-center animate-slide-up">
                <div className="w-full max-w-md glass-panel p-8 rounded-2xl shadow-2xl">
                    <div className="text-center mb-8">
                        <Icon name="brain-circuit" size={48} className="mx-auto text-cyan-400 mb-4" />
                        <h2 className="text-xl font-bold text-slate-300">Join the Quiz</h2>
                    </div>

                    <div className="space-y-4">
                        <div>
                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Nickname</label>
                            <input type="text" value={userName} onChange={e => setUserName(e.target.value)} 
                                className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 text-white focus:border-cyan-500 outline-none" placeholder="SmartyPants" />
                        </div>
                        
                        <button onClick={createRoom} className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:brightness-110 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2">
                            <Icon name="plus-circle" size={18} /> Host Game
                        </button>
                        
                        <div className="flex items-center gap-2">
                            <input type="text" value={roomCode} onChange={e => setRoomCode(e.target.value.toUpperCase())} 
                                className="w-24 bg-slate-900/50 border border-slate-700 rounded-xl p-3 text-center font-mono text-lg uppercase" placeholder="CODE" maxLength={4} />
                            <button onClick={joinRoom} className="flex-1 bg-slate-700 hover:bg-slate-600 font-bold py-3 rounded-xl">Join</button>
                        </div>
                    </div>
                    
                    <button onClick={enterSpectator} className="w-full mt-6 text-slate-500 text-sm hover:text-cyan-400 flex justify-center gap-2">
                        <Icon name="tv" size={16} /> TV / Spectator Mode
                    </button>
                </div>
            </div>
        );

        const LobbyView = ({ gameState, user, db }) => {
            if (gameState.status !== 'lobby') return null;
            const isHost = gameState.hostId === user.uid;
            const roomRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'rooms', `trivia_room_${gameState.code}`);

            const updateMyData = async (field, value) => {
                const newPlayers = gameState.players.map(p => 
                    p.uid === user.uid ? { ...p, [field]: value } : p
                );
                await updateDoc(roomRef, { players: newPlayers });
            };
            
            const updateMyVote = async (key, value) => {
                const newPlayers = gameState.players.map(p => 
                    p.uid === user.uid ? { ...p, votes: { ...p.votes, [key]: value } } : p
                );
                await updateDoc(roomRef, { players: newPlayers });
            };

            const startGame = async () => {
                // Tally Votes
                const catVotes = {};
                gameState.players.forEach(p => {
                    const v = p.votes || { category: '9' };
                    catVotes[v.category] = (catVotes[v.category] || 0) + 1;
                });
                const winnerCat = Object.keys(catVotes).reduce((a, b) => catVotes[a] > catVotes[b] ? a : b);
                
                try {
                    const res = await fetch(`https://opentdb.com/api.php?amount=3&category=${winnerCat}&difficulty=medium&type=multiple`);
                    const data = await res.json();
                    
                    if (data.response_code !== 0) throw new Error("API Error");

                    const processedQuestions = data.results.map(q => ({
                        question: decodeHTML(q.question),
                        correctAnswer: decodeHTML(q.correct_answer),
                        allAnswers: shuffle([...q.incorrect_answers, q.correct_answer].map(decodeHTML))
                    }));

                    await updateDoc(roomRef, {
                        questions: processedQuestions,
                        status: 'question',
                        currentQuestionIndex: 0,
                        timeLeft: gameState.timerDuration || 20 // Initialize synced timer
                    });
                } catch (e) {
                    console.error(e);
                    alert("Failed to fetch questions. Try changing votes.");
                }
            };
            
            const myData = gameState.players.find(p => p.uid === user.uid) || {};

            return (
                <div className="flex flex-col gap-6 animate-pop pb-12">
                    
                    {isHost && (
                        <div className="glass-panel p-6 rounded-2xl border-l-4 border-l-fuchsia-500">
                            <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="settings-2" /> Host Controls</h2>
                            <div className="flex gap-4 flex-wrap">
                                <div className="flex-1 min-w-[200px]">
                                    <label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Game Mode</label>
                                    <div className="flex bg-slate-900 rounded-lg p-1">
                                        <button onClick={() => updateDoc(roomRef, { gameMode: 'ffa' })} className={`flex-1 py-2 rounded text-sm font-bold transition ${gameState.gameMode === 'ffa' ? 'bg-cyan-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>Free For All</button>
                                        <button onClick={() => updateDoc(roomRef, { gameMode: 'teams' })} className={`flex-1 py-2 rounded text-sm font-bold transition ${gameState.gameMode === 'teams' ? 'bg-cyan-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>Teams</button>
                                    </div>
                                </div>
                                <div className="flex-1 min-w-[200px]">
                                    <label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Timer: {gameState.timerDuration}s</label>
                                    <input type="range" min="10" max="30" step="5" value={gameState.timerDuration || 20} onChange={e => updateDoc(roomRef, { timerDuration: parseInt(e.target.value) })} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex flex-col md:flex-row gap-6">
                        <div className="flex-1 glass-panel p-6 rounded-2xl">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-cyan-400"><Icon name="vote" /> Vote Round 1</h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs text-slate-500 font-bold uppercase">First Category</label>
                                    <div className="grid grid-cols-2 gap-2 mt-2">
                                        {CATEGORIES.map(c => (
                                            <button 
                                                key={c.id} 
                                                onClick={() => updateMyVote('category', c.id)}
                                                className={`p-2 rounded text-sm font-bold flex items-center gap-2 ${myData.votes?.category === c.id ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400'}`}
                                            >
                                                <Icon name={c.icon} size={14} /> {c.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                {gameState.gameMode === 'teams' && (
                                    <div className="pt-2">
                                        <label className="text-xs text-slate-500 font-bold uppercase mb-2 block">Select Team</label>
                                        <div className="grid grid-cols-4 gap-2">
                                            {Object.keys(TEAMS).map(key => (
                                                <button key={key} onClick={() => updateMyData('team', key)} 
                                                    className={`h-12 rounded-lg border-2 transition ${TEAMS[key].color} ${myData.team === key ? 'ring-2 ring-white scale-110' : 'opacity-40 hover:opacity-100'}`} 
                                                    title={TEAMS[key].name} />
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="flex-1 glass-panel p-6 rounded-2xl">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-fuchsia-400"><Icon name="users" /> Players ({gameState.players.length})</h2>
                            <div className="grid gap-2 max-h-60 overflow-y-auto pr-2">
                                {gameState.players.map(p => (
                                    <div key={p.uid} className={`bg-slate-800 p-3 rounded-lg flex justify-between items-center border-l-4 ${gameState.gameMode === 'teams' ? TEAMS[p.team || 'red'].border : 'border-slate-600'}`}>
                                        <span className="font-semibold">{p.name}</span>
                                        {p.uid === gameState.hostId && <Icon name="crown" size={14} className="text-yellow-500" />}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {isHost ? (
                        <button onClick={startGame} className="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 py-4 rounded-xl font-bold text-lg shadow-lg shadow-green-500/20">
                            Start Game (Round 1)
                        </button>
                    ) : (
                        <div className="text-center p-4 bg-slate-800/50 rounded-xl animate-pulse text-slate-400">
                            Waiting for host to start...
                        </div>
                    )}
                </div>
            );
        };

        const GameController = ({ gameState, user, db }) => {
            const roomRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'rooms', `trivia_room_${gameState.code}`);
            const isHost = gameState.hostId === user.uid;
            
            const currentQ = gameState.questions[gameState.currentQuestionIndex];
            const myAnswer = gameState.currentAnswers?.[user.uid];

            // --- HOST LOGIC (Synced Timer) ---
            useEffect(() => {
                if (!isHost) return;

                const timer = setInterval(() => {
                    // Decrement logic
                    if (gameState.status === 'question' || gameState.status === 'category_vote') {
                        if (gameState.timeLeft > 0) {
                            updateDoc(roomRef, { timeLeft: increment(-1) });
                        } else {
                             // Time is up
                             if (gameState.status === 'question') {
                                 updateDoc(roomRef, { status: 'reveal' });
                             } else if (gameState.status === 'category_vote') {
                                 endCategoryVote();
                             }
                        }
                    }
                }, 1000);

                return () => clearInterval(timer);
            }, [isHost, gameState.status, gameState.timeLeft]);

            const submitAnswer = async (ans) => {
                if (gameState.status !== 'question' || myAnswer) return;
                await updateDoc(roomRef, { [`currentAnswers.${user.uid}`]: ans });
            };

            const castLiveVote = async (catId) => {
                await updateDoc(roomRef, { [`liveVotes.${user.uid}`]: catId });
            }

            const endCategoryVote = async () => {
                const votes = gameState.liveVotes || {};
                const counts = {};
                let winner = CATEGORIES[Math.floor(Math.random() * CATEGORIES.length)].id;
                
                if (Object.keys(votes).length > 0) {
                    Object.values(votes).forEach(v => counts[v] = (counts[v] || 0) + 1);
                    winner = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                }

                try {
                    const res = await fetch(`https://opentdb.com/api.php?amount=3&category=${winner}&difficulty=medium&type=multiple`);
                    const data = await res.json();
                    
                    const newQuestions = data.results.map(q => ({
                        question: decodeHTML(q.question),
                        correctAnswer: decodeHTML(q.correct_answer),
                        allAnswers: shuffle([...q.incorrect_answers, q.correct_answer].map(decodeHTML))
                    }));

                    const updatedQuestions = [...gameState.questions, ...newQuestions];

                    await updateDoc(roomRef, {
                        questions: updatedQuestions,
                        status: 'question',
                        currentQuestionIndex: gameState.currentQuestionIndex + 1, 
                        timeLeft: 15, // Vote round over, new question gets 15s (or setting)
                    });

                } catch (e) {
                    console.error("Fetch failed", e);
                    await updateDoc(roomRef, { status: 'finished' });
                }
            };

            const nextQuestion = async () => {
                const currentIndex = gameState.currentQuestionIndex;
                const totalQuestions = gameState.questions.length;
                
                const newPlayers = gameState.players.map(p => {
                    const ans = gameState.currentAnswers[p.uid];
                    const isCorrect = ans === currentQ.correctAnswer;
                    return isCorrect ? { ...p, score: p.score + 100 } : p;
                });

                const nextIndex = currentIndex + 1;
                const isVoteRound = (nextIndex % 3 === 0) && (nextIndex < 12);
                
                if (nextIndex >= totalQuestions && !isVoteRound) {
                    // End game if max limit reached or just finish
                     if (totalQuestions >= 12) {
                        await updateDoc(roomRef, { players: newPlayers, status: 'finished' });
                    } else {
                         // Should trigger vote but simple check:
                         await updateDoc(roomRef, { players: newPlayers, status: 'finished' });
                    }
                } else {
                    if (isVoteRound) {
                        await updateDoc(roomRef, { 
                            players: newPlayers,
                            status: 'category_vote',
                            currentAnswers: {}, 
                            liveVotes: {},
                            timeLeft: 15 // 15s for voting
                        });
                    } else {
                        await updateDoc(roomRef, { 
                            players: newPlayers,
                            status: 'question',
                            currentQuestionIndex: nextIndex,
                            currentAnswers: {}, 
                            timeLeft: gameState.timerDuration || 20
                        });
                    }
                }
            };

            if (gameState.status === 'finished') return <Leaderboard gameState={gameState} />;
            
            if (gameState.status === 'category_vote') {
                return (
                    <div className="max-w-xl mx-auto flex flex-col items-center animate-pop">
                        <div className="w-full text-center mb-8">
                            <div className="text-6xl font-black font-mono text-cyan-400 mb-4">{gameState.timeLeft}</div>
                            <h2 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-400 to-cyan-400 mb-2">NEXT ROUND VOTE</h2>
                            <p className="text-slate-400">Choose the next category!</p>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4 w-full">
                             {CATEGORIES.map(c => {
                                 const myVote = gameState.liveVotes?.[user.uid];
                                 const isSelected = myVote === c.id;
                                 return (
                                     <button 
                                        key={c.id} 
                                        onClick={() => castLiveVote(c.id)}
                                        className={`p-4 rounded-xl font-bold flex flex-col items-center gap-2 transition-all ${isSelected ? 'bg-cyan-600 text-white scale-105 border-2 border-cyan-400' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                                     >
                                         <Icon name={c.icon} size={24} />
                                         {c.name}
                                     </button>
                                 );
                             })}
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-xl mx-auto flex flex-col items-center">
                    {/* Progress & Score */}
                    <div className="w-full flex justify-between items-center mb-4 text-xs font-bold uppercase tracking-widest text-slate-500">
                        <span>Question {gameState.currentQuestionIndex + 1}</span>
                        <span className="text-cyan-400 text-lg">Score: {gameState.players.find(p => p.uid === user.uid)?.score || 0}</span>
                    </div>
                    
                    <div className="flex items-center gap-4 w-full mb-6">
                        <div className="flex-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                            <div className="h-full bg-cyan-500 transition-all duration-1000" style={{ width: `${((gameState.currentQuestionIndex + 1) / 12) * 100}%` }}></div>
                        </div>
                        <div className="font-mono text-2xl font-black text-white w-8 text-center">{gameState.timeLeft}</div>
                    </div>

                    <div className="glass-panel p-6 rounded-2xl w-full mb-6">
                        <h2 className="text-xl md:text-2xl font-bold leading-tight">{currentQ.question}</h2>
                    </div>

                    {gameState.status === 'question' && (
                        <div className="grid grid-cols-1 gap-3 w-full">
                            {currentQ.allAnswers.map((ans, i) => (
                                <button key={i} onClick={() => submitAnswer(ans)}
                                    disabled={!!myAnswer}
                                    className={`p-4 rounded-xl text-left font-semibold transition-all ${
                                        myAnswer === ans 
                                            ? 'bg-cyan-600 border-2 border-cyan-400 text-white' 
                                            : 'bg-slate-800 hover:bg-slate-700 border-2 border-transparent'
                                    } ${!!myAnswer && myAnswer !== ans ? 'opacity-50' : ''}`}
                                >
                                    {ans}
                                </button>
                            ))}
                        </div>
                    )}

                    {gameState.status === 'reveal' && (
                        <div className="w-full text-center animate-pop">
                            <div className="mb-6">
                                <div className="text-slate-400 text-sm uppercase font-bold">Correct Answer</div>
                                <div className="text-2xl font-bold text-green-400">{currentQ.correctAnswer}</div>
                            </div>
                            
                            <div className={`p-4 rounded-xl mb-6 ${myAnswer === currentQ.correctAnswer ? 'bg-green-500/20 text-green-200' : 'bg-red-500/20 text-red-200'}`}>
                                {myAnswer === currentQ.correctAnswer ? "You got it! +100 pts" : "Missed it!"}
                            </div>

                            {isHost && (
                                <div className="flex flex-col gap-2">
                                    <button onClick={nextQuestion} className="w-full bg-cyan-600 hover:bg-cyan-500 py-4 rounded-xl font-bold text-white shadow-lg shadow-cyan-500/30">
                                        Next Question <Icon name="arrow-right" size={18} className="inline ml-2"/>
                                    </button>
                                    {(gameState.currentQuestionIndex + 1) % 3 === 0 && (gameState.currentQuestionIndex + 1) < 12 && (
                                        <div className="text-xs text-fuchsia-400 font-bold uppercase tracking-widest animate-pulse">
                                            Upcoming: Category Vote!
                                        </div>
                                    )}
                                </div>
                            )}
                            {!isHost && <div className="text-slate-500 animate-pulse">Waiting for host...</div>}
                        </div>
                    )}
                </div>
            );
        };

        const SpectatorView = ({ roomCode, gameState }) => {
            if (!gameState) return <div className="h-screen flex items-center justify-center text-slate-500">Connecting to {roomCode}...</div>;
            
            const currentQ = gameState.questions?.[gameState.currentQuestionIndex];
            const teamScores = useMemo(() => {
                if (gameState.gameMode !== 'teams') return null;
                const scores = { red: 0, blue: 0, green: 0, yellow: 0 };
                gameState.players.forEach(p => {
                    if (scores[p.team] !== undefined) scores[p.team] += p.score;
                });
                return scores;
            }, [gameState.players, gameState.gameMode]);

            return (
                <div className="fixed inset-0 bg-slate-950 flex flex-col p-8 overflow-hidden z-50">
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-1/4 left-1/4 w-[500px] h-[500px] bg-cyan-600/10 rounded-full blur-3xl animate-pulse"></div>
                    </div>

                    <div className="relative z-10 flex justify-between items-center mb-8 border-b border-white/10 pb-4">
                        <div>
                            <h1 className="text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-fuchsia-400">TRIVIA PARTY</h1>
                            <div className="text-xl text-slate-400 mt-2 flex gap-4">
                                <span>Room: <span className="font-mono text-white font-bold">{gameState.code}</span></span>
                                {gameState.status === 'lobby' && (
                                    <span className="text-cyan-400 border border-cyan-500/30 px-2 rounded">
                                        Mode: {gameState.gameMode === 'teams' ? 'TEAMS' : 'FREE FOR ALL'}
                                    </span>
                                )}
                            </div>
                        </div>
                        {gameState.status === 'lobby' && (
                             <img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.href.split('?')[0] + `?room=${gameState.code}`)}&color=22d3ee&bgcolor=020617`} className="rounded-xl border-2 border-slate-700 w-24 h-24" alt="Join QR" />
                        )}
                         {gameState.status !== 'lobby' && gameState.gameMode === 'teams' && (
                             <div className="flex gap-4">
                                {Object.entries(teamScores).map(([key, score]) => (
                                    <div key={key} className={`flex flex-col items-center p-2 rounded ${TEAMS[key].color} bg-opacity-20 border ${TEAMS[key].border}`}>
                                        <div className={`text-xs uppercase font-bold ${TEAMS[key].text}`}>{key}</div>
                                        <div className="font-mono text-xl font-black">{score}</div>
                                    </div>
                                ))}
                             </div>
                         )}
                    </div>

                    <div className="flex-grow flex flex-col justify-center items-center relative z-10 w-full max-w-6xl mx-auto">
                        {gameState.status === 'lobby' && (
                            <div className="w-full text-center">
                                <h2 className="text-3xl font-bold mb-8 text-slate-300">
                                    Vote Leader: <span className="text-cyan-400">N/A (Hidden)</span>
                                </h2>
                                <div className="grid grid-cols-4 gap-4">
                                    {gameState.players.map(p => (
                                        <div key={p.uid} className={`bg-slate-800 p-4 rounded-2xl border-b-4 flex flex-col items-center animate-pop ${gameState.gameMode === 'teams' ? TEAMS[p.team || 'red'].border : 'border-slate-700'}`}>
                                            <div className="w-12 h-12 bg-gradient-to-br from-slate-700 to-slate-600 rounded-full mb-2 flex items-center justify-center text-xl font-bold">
                                                {p.name[0]}
                                            </div>
                                            <div className="font-bold">{p.name}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {gameState.status === 'category_vote' && (
                            <div className="text-center w-full">
                                <div className="text-6xl font-black font-mono text-cyan-400 mb-4">{gameState.timeLeft}</div>
                                <h2 className="text-5xl font-black mb-12 text-white">VOTE FOR NEXT CATEGORY</h2>
                                <div className="grid grid-cols-4 gap-6">
                                    {CATEGORIES.map(c => {
                                         const count = Object.values(gameState.liveVotes || {}).filter(v => v === c.id).length;
                                         return (
                                             <div key={c.id} className={`p-6 rounded-2xl bg-slate-800 border-2 transition-all ${count > 0 ? 'border-fuchsia-500 bg-fuchsia-900/20' : 'border-slate-700'}`}>
                                                 <Icon name={c.icon} size={48} className={`mx-auto mb-4 ${count > 0 ? 'text-fuchsia-400' : 'text-slate-500'}`} />
                                                 <div className="text-xl font-bold">{c.name}</div>
                                                 {count > 0 && <div className="mt-2 text-2xl font-black text-white">{count}</div>}
                                             </div>
                                         )
                                    })}
                                </div>
                            </div>
                        )}

                        {gameState.status === 'question' && (
                            <div className="w-full">
                                <div className="flex justify-between items-end mb-8">
                                    <div className="text-cyan-400 font-bold tracking-widest uppercase">Question {gameState.currentQuestionIndex + 1}</div>
                                    <div className="text-6xl font-black font-mono text-slate-700">{gameState.timeLeft}</div>
                                </div>
                                
                                <h2 className="text-5xl font-bold leading-tight mb-12 text-center text-white">{currentQ.question}</h2>

                                <div className="grid grid-cols-2 gap-6">
                                    {currentQ.allAnswers.map((ans, i) => (
                                        <div key={i} className="bg-slate-800/50 border border-slate-700 p-8 rounded-2xl text-2xl font-semibold text-slate-300">
                                            {ans}
                                        </div>
                                    ))}
                                </div>

                                <div className="mt-12 flex gap-2 justify-center flex-wrap">
                                    {gameState.players.map(p => {
                                        const hasAnswered = !!gameState.currentAnswers?.[p.uid];
                                        return (
                                            <div key={p.uid} className={`w-3 h-3 rounded-full transition-all ${hasAnswered ? 'bg-green-500 scale-125' : 'bg-slate-800'}`}></div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {gameState.status === 'reveal' && (
                            <div className="w-full text-center">
                                <div className="text-3xl font-bold text-slate-400 mb-4">The answer was...</div>
                                <div className="text-6xl font-black text-green-400 mb-12 animate-pop">{currentQ.correctAnswer}</div>

                                <div className="grid grid-cols-4 gap-4">
                                    {gameState.players.map(p => {
                                        const ans = gameState.currentAnswers[p.uid];
                                        const isCorrect = ans === currentQ.correctAnswer;
                                        return (
                                            <div key={p.uid} className={`p-4 rounded-xl border transition-all ${isCorrect ? 'bg-green-500/20 border-green-500' : 'bg-red-500/10 border-red-900 opacity-50'}`}>
                                                <div className="font-bold text-lg mb-1">{p.name}</div>
                                                {isCorrect && <div className="font-bold text-green-400">+100</div>}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {gameState.status === 'finished' && <Leaderboard gameState={gameState} isTv={true} />}

                    </div>
                </div>
            );
        };

        const Leaderboard = ({ gameState, isTv = false }) => {
            const sorted = [...gameState.players].sort((a, b) => b.score - a.score);
            const teamScores = gameState.gameMode === 'teams' ? Object.keys(TEAMS).map(color => {
                return { 
                    color, 
                    score: gameState.players.filter(p => p.team === color).reduce((acc, p) => acc + p.score, 0),
                    details: TEAMS[color]
                };
            }).sort((a, b) => b.score - a.score) : null;

            return (
                <div className={`w-full max-w-5xl mx-auto flex gap-12 ${isTv ? 'scale-110 origin-top' : ''}`}>
                    
                    {teamScores && (
                        <div className="flex-1">
                            <h2 className="text-2xl font-black mb-6 uppercase text-slate-400">Team Standings</h2>
                            <div className="space-y-4">
                                {teamScores.map((t, i) => (
                                    <div key={t.color} className={`flex items-center p-4 rounded-xl border-l-8 ${t.details.color} bg-slate-800 border-slate-700 bg-opacity-50`}>
                                        <div className="flex-1 font-bold text-xl">{t.details.name}</div>
                                        <div className="font-mono text-3xl font-black">{t.score}</div>
                                        {i === 0 && <Icon name="trophy" className="ml-4 text-yellow-400" />}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="flex-1">
                        <h2 className="text-2xl font-black mb-6 uppercase text-slate-400">Individual MVPs</h2>
                        <div className="space-y-3">
                            {sorted.slice(0, 8).map((p, i) => (
                                <div key={p.uid} className={`flex items-center p-3 rounded-lg border ${i===0 ? 'bg-yellow-500/20 border-yellow-500' : 'bg-slate-800 border-slate-700'}`}>
                                    <div className={`w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm mr-4 ${i===0 ? 'bg-yellow-500 text-black' : 'bg-slate-700 text-slate-400'}`}>
                                        {i + 1}
                                    </div>
                                    <div className="flex-1 font-bold">{p.name}</div>
                                    <div className="font-mono text-xl font-black text-cyan-400">{p.score}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
